<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CitySort AI MVP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <script>
      (() => {
        const root = document.documentElement;
        const applyTimeTheme = () => {
          const hour = new Date().getHours();
          const isDark = hour >= 19 || hour < 7;
          root.setAttribute("data-theme", isDark ? "dark" : "light");
        };
        applyTimeTheme();
        window.setInterval(applyTimeTheme, 60000);
      })();
    </script>
    <style>
      /* Critical fallback so shell layout remains usable if stale cached CSS is served. */
      :root {
        --bg: #f5f7fb;
        --surface: #ffffff;
        --surface-muted: #f2f4fa;
        --line: #dde3ef;
        --ink: #171b24;
        --ink-soft: #5f677a;
        --accent: #8b5cf6;
        --accent-soft: #f2edff;
        --primary-btn-bg: #12131a;
        --primary-btn-text: #f7f8fc;
      }

      html[data-theme="dark"] {
        --bg: #0b0f18;
        --surface: #121825;
        --surface-muted: #0f1522;
        --line: #2b3548;
        --ink: #eef2ff;
        --ink-soft: #9ba6bf;
        --accent: #b69aff;
        --accent-soft: #2c2441;
        --primary-btn-bg: #b69aff;
        --primary-btn-text: #1a112f;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        font-size: 16px;
        background: var(--bg);
        color: var(--ink);
        font-family: "IBM Plex Sans", "Segoe UI", -apple-system, sans-serif;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      .app-shell {
        min-height: 100vh;
        display: grid;
        grid-template-columns: 268px 1fr;
      }

      .shell-sidebar {
        border-right: 1px solid var(--line);
        background: var(--surface-muted);
        padding: 0.75rem;
      }

      .sidebar-link {
        display: block;
        color: var(--ink-soft);
        padding: 0.35rem 0.42rem;
        border-radius: 0.38rem;
      }

      .sidebar-service {
        border: 1px solid var(--line);
        border-radius: 0.56rem;
        background: var(--surface);
        padding: 0.48rem;
      }

      .sidebar-link.active {
        background: var(--accent-soft);
        color: var(--accent);
      }

      .shell-main {
        padding: 0.75rem;
      }

      .shell-topbar {
        border: 1px solid var(--line);
        border-radius: 0.42rem;
        background: var(--surface);
        padding: 0.72rem 0.9rem;
      }

      .topbar-meta {
        margin-top: 0.54rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.34rem;
      }

      .meta-chip {
        display: inline-flex;
        align-items: center;
        border-radius: 0.28rem;
        border: 1px solid var(--line);
        background: var(--surface-muted);
        color: var(--ink-soft);
        font-size: 0.72rem;
        padding: 0.18rem 0.38rem;
      }

      .meta-chip.accent {
        border-color: var(--accent);
        background: var(--accent-soft);
        color: var(--accent);
      }

      .shell-tabs {
        margin-top: 0.58rem;
        display: flex;
        gap: 0.14rem;
        border-bottom: 1px solid var(--line);
        overflow-x: auto;
      }

      .topbar-actions {
        display: flex;
        gap: 0.4rem;
        justify-content: flex-end;
      }

      .tab {
        color: var(--ink-soft);
        padding: 0.44rem 0.58rem;
        border-bottom: 2px solid transparent;
        white-space: nowrap;
      }

      .tab.active {
        color: var(--accent);
        border-color: var(--accent);
      }

      .layout {
        margin-top: 0.62rem;
        display: grid;
        grid-template-columns: repeat(12, minmax(0, 1fr));
        gap: 0.68rem;
      }

      .panel {
        border-radius: 0.42rem;
        border: 1px solid var(--line);
        background: var(--surface);
        padding: 0.75rem;
      }

      .panel.is-page-hidden {
        display: none;
      }

      .upload-panel {
        grid-column: span 4;
      }

      .metrics-panel {
        grid-column: span 8;
      }

      .db-import-panel,
      .review-panel,
      .rules-panel {
        grid-column: span 12;
      }

      .queues-panel,
      .worklist-panel {
        grid-column: span 6;
      }

      @media (max-width: 1320px) {
        .upload-panel,
        .metrics-panel,
        .queues-panel,
        .worklist-panel {
          grid-column: span 12;
        }
      }

      @media (max-width: 1040px) {
        .app-shell {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <link rel="stylesheet" href="/static/styles.v2.css" />
  </head>
  <body>
    <div class="app-shell">
      <aside class="shell-sidebar">
        <div class="sidebar-brand">
          <div class="brand-mark" aria-hidden="true">CS</div>
          <div>
            <p class="sidebar-kicker">CitySort</p>
            <strong>Operations Suite</strong>
          </div>
        </div>

        <div class="sidebar-service">
          <a href="/?page=overview" class="sidebar-home">Dashboard</a>
          <strong>citysort</strong>
        </div>

        <div class="sidebar-group">
          <p class="sidebar-label">Monitor</p>
          <a href="/?page=overview" class="sidebar-link active" data-page="overview">Events</a>
          <a href="/?page=queues" class="sidebar-link" data-page="queues">Logs</a>
          <a href="/?page=upload" class="sidebar-link" data-page="upload">Metrics</a>
        </div>

        <div class="sidebar-group">
          <p class="sidebar-label">Manage</p>
          <a href="/?page=db-import" class="sidebar-link" data-page="db-import">Database</a>
          <a href="/?page=review" class="sidebar-link" data-page="review">Human review</a>
          <a href="/?page=rules" class="sidebar-link" data-page="rules">Settings</a>
        </div>

        <div class="sidebar-footer">CitySort AI MVP</div>
      </aside>

      <div class="shell-main" id="dashboard">
        <header class="shell-topbar">
          <div class="topbar-main">
            <p class="kicker">citysort / web service</p>
            <h1>Ingestion and usage</h1>
            <p class="subtitle">Classify, validate, route, and review incoming city documents from a single control plane.</p>
            <div class="topbar-meta">
              <span class="meta-chip">Python 3</span>
              <span class="meta-chip">Free</span>
              <span class="meta-chip accent">Blueprint managed</span>
            </div>
          </div>
          <div class="hero-tools">
            <div class="topbar-actions">
              <button type="button" class="secondary">Connect</button>
              <button type="button">Manual Deploy</button>
            </div>
            <div class="hero-chip">
              <span>Workspace</span>
              <strong>Personal</strong>
            </div>
            <p id="last-updated" class="status hero-updated">Updated: --</p>
            <button id="refresh" class="secondary">Refresh Data</button>
          </div>
        </header>

        <nav class="shell-tabs">
          <a href="/?page=overview" class="tab active" data-page="overview">Events</a>
          <a href="/?page=queues" class="tab" data-page="queues">Logs</a>
          <a href="/?page=upload" class="tab" data-page="upload">Metrics</a>
          <a href="/?page=db-import" class="tab" data-page="db-import">Database</a>
          <a href="/?page=review" class="tab" data-page="review">Review</a>
          <a href="/?page=rules" class="tab" data-page="rules">Settings</a>
        </nav>

        <main class="layout">
          <section class="panel upload-panel" data-pages="overview upload">
            <div class="section-head">
              <h2>Upload Documents</h2>
              <p>Intake pipeline</p>
            </div>
            <form id="upload-form">
              <input
                id="file-input"
                name="file"
                type="file"
                accept=".pdf,.txt,.md,.csv,.json,.png,.jpg,.jpeg,.tiff"
                multiple
                required
              />
              <button type="submit">Upload & Process</button>
            </form>
            <p id="upload-status" class="status"></p>
          </section>

          <section class="panel metrics-panel" data-pages="overview upload">
            <div class="section-head">
              <h2>Operational Metrics</h2>
              <p>Live snapshot</p>
            </div>
            <div class="metrics">
              <article>
                <span>Total Documents</span>
                <strong id="metric-total">0</strong>
              </article>
              <article>
                <span>Needs Review</span>
                <strong id="metric-review">0</strong>
              </article>
              <article>
                <span>Routed / Approved</span>
                <strong id="metric-routed">0</strong>
              </article>
              <article>
                <span>Average Confidence</span>
                <strong id="metric-confidence">0%</strong>
              </article>
            </div>
          </section>

          <section class="panel db-import-panel" data-pages="overview db-import">
            <div class="section-head">
              <h2>Database Import</h2>
              <p>Bulk ingest from SQL</p>
            </div>
            <form id="db-import-form">
              <label for="db-url">Database URL</label>
              <input
                id="db-url"
                type="text"
                placeholder="postgresql://user:pass@host:5432/dbname (also supports sqlite/mysql)"
                required
              />

              <label for="db-query">SQL Query (SELECT)</label>
              <textarea id="db-query" rows="4" spellcheck="false">
SELECT filename, content, content_type
FROM documents_to_ingest</textarea
              >

              <div class="db-import-grid">
                <div>
                  <label for="db-filename-column">Filename Column</label>
                  <input id="db-filename-column" type="text" value="filename" />
                </div>
                <div>
                  <label for="db-content-column">Content Column</label>
                  <input id="db-content-column" type="text" value="content" />
                </div>
                <div>
                  <label for="db-path-column">File Path Column (optional)</label>
                  <input id="db-path-column" type="text" placeholder="file_path" />
                </div>
                <div>
                  <label for="db-content-type-column">Content-Type Column</label>
                  <input id="db-content-type-column" type="text" value="content_type" />
                </div>
                <div>
                  <label for="db-limit">Row Limit</label>
                  <input id="db-limit" type="number" min="1" max="5000" value="500" />
                </div>
              </div>

              <label class="check-inline" for="db-process-async">
                <input id="db-process-async" type="checkbox" />
                Process asynchronously
              </label>

              <div class="actions">
                <button id="db-import-submit" type="submit">Import & Process</button>
              </div>
            </form>
            <p id="db-import-status" class="status"></p>
          </section>

          <section class="panel queues-panel" data-pages="overview queues">
            <div class="section-head">
              <h2>Department Queues</h2>
              <p>Routing distribution</p>
            </div>
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Department</th>
                    <th>Total</th>
                    <th>Needs Review</th>
                    <th>Ready</th>
                  </tr>
                </thead>
                <tbody id="queue-body"></tbody>
              </table>
            </div>
          </section>

          <section class="panel worklist-panel" data-pages="overview queues">
            <div class="section-head">
              <h2>Document Worklist</h2>
              <p>Most recent 200 records</p>
            </div>
            <div class="filters">
              <label for="filter-status">Status</label>
              <select id="filter-status">
                <option value="">All</option>
                <option value="needs_review">needs_review</option>
                <option value="routed">routed</option>
                <option value="approved">approved</option>
                <option value="corrected">corrected</option>
                <option value="failed">failed</option>
              </select>
              <label for="filter-department">Department</label>
              <input id="filter-department" type="text" placeholder="e.g. City Clerk" />
              <label for="filter-search">File Search</label>
              <input id="filter-search" type="text" placeholder="filename..." />
            </div>
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th>File</th>
                    <th>Type</th>
                    <th>Department</th>
                    <th>Status</th>
                    <th>Confidence</th>
                    <th>Review</th>
                  </tr>
                </thead>
                <tbody id="docs-body"></tbody>
              </table>
            </div>
          </section>

          <section class="panel review-panel" id="review-panel" data-pages="overview review">
            <div class="section-head">
              <h2>Human Review</h2>
              <p>Decision support</p>
            </div>
            <div class="review-context">
              <p id="review-selected">Select a document from the worklist.</p>
              <div class="review-tags">
                <span id="review-current-status">Status: -</span>
                <span id="review-current-type">Type: -</span>
                <span id="review-current-department">Department: -</span>
                <span id="review-current-confidence">Confidence: -</span>
              </div>
            </div>

            <div class="review-columns">
              <div>
                <label for="review-missing">Missing Required Fields</label>
                <pre id="review-missing" class="mono-block">-</pre>
              </div>
              <div>
                <label for="review-errors">Validation Errors</label>
                <pre id="review-errors" class="mono-block">-</pre>
              </div>
            </div>

            <form id="review-form">
              <input type="hidden" id="review-id" />

              <label for="review-doc-type">Corrected Type</label>
              <select id="review-doc-type">
                <option value="">(No change)</option>
                <option value="building_permit">building_permit</option>
                <option value="business_license">business_license</option>
                <option value="foi_request">foi_request</option>
                <option value="zoning_variance">zoning_variance</option>
                <option value="complaint">complaint</option>
                <option value="benefits_application">benefits_application</option>
                <option value="court_filing">court_filing</option>
                <option value="other">other</option>
              </select>

              <label for="review-department">Corrected Department</label>
              <input id="review-department" type="text" placeholder="Optional" />

              <label for="review-notes">Notes</label>
              <textarea id="review-notes" rows="3" placeholder="What changed and why?"></textarea>

              <label for="review-fields-json">Corrected Fields (JSON)</label>
              <textarea id="review-fields-json" rows="7" spellcheck="false">{}</textarea>

              <div class="actions">
                <button type="submit">Approve</button>
                <button type="button" id="reject" class="secondary">Keep In Review</button>
                <button type="button" id="reprocess" class="secondary">Reprocess</button>
              </div>
            </form>

            <label for="review-text-preview">Extracted Text Preview</label>
            <pre id="review-text-preview" class="mono-block">-</pre>

            <label for="review-audit">Audit Trail (Latest First)</label>
            <pre id="review-audit" class="mono-block">-</pre>
            <p id="review-status" class="status"></p>
          </section>

          <section class="panel rules-panel" data-pages="overview rules">
            <div class="section-head">
              <h2>Routing Rules Editor</h2>
              <p>Policy logic for new uploads</p>
            </div>
            <p class="subtitle-small">
              Edit document types, keywords, required fields, and department mapping. Changes apply immediately to new
              uploads.
            </p>
            <p id="rules-meta" class="status">Source: -</p>
            <div class="actions">
              <button type="button" id="rules-load" class="secondary">Load Rules</button>
              <button type="button" id="rules-add" class="secondary">Add Type</button>
              <button type="button" id="rules-save">Save Rules</button>
              <button type="button" id="rules-reset" class="secondary">Reset Defaults</button>
            </div>

            <div id="rules-builder" class="rules-builder"></div>

            <details class="rules-advanced">
              <summary>Advanced JSON Editor</summary>
              <p class="subtitle-small">Optional. You can edit JSON directly, then apply it back to the form view.</p>
              <div class="actions">
                <button type="button" id="rules-apply-json" class="secondary">Apply JSON To Form</button>
              </div>
              <label for="rules-json">Rules JSON</label>
              <textarea id="rules-json" rows="14" spellcheck="false">{}</textarea>
            </details>
            <p id="rules-status" class="status"></p>
          </section>
        </main>
      </div>
    </div>

    <script>
      (() => {
        const pageConfig = {
          overview: {
            title: "Events",
            subtitle: "Track document lifecycle activity and deployment-impacting events in one timeline.",
          },
          upload: {
            title: "Metrics",
            subtitle: "Monitor intake throughput, confidence trends, and operational volume at a glance.",
          },
          "db-import": {
            title: "Database",
            subtitle: "Connect your source database and ingest records directly into the processing pipeline.",
          },
          queues: {
            title: "Logs",
            subtitle: "Inspect queue activity and processing output streams for operational visibility.",
          },
          review: {
            title: "Human review",
            subtitle: "Review low-confidence documents and apply corrections with full audit visibility.",
          },
          rules: {
            title: "Settings",
            subtitle: "Manage routing logic, required fields, and document-type classification behavior.",
          },
        };

        const requestedPage = (new URLSearchParams(window.location.search).get("page") || "overview").trim().toLowerCase();
        const activePage = Object.prototype.hasOwnProperty.call(pageConfig, requestedPage) ? requestedPage : "overview";

        const titleEl = document.querySelector(".shell-topbar h1");
        const subtitleEl = document.querySelector(".shell-topbar .subtitle");
        const meta = pageConfig[activePage];
        if (titleEl && meta) titleEl.textContent = meta.title;
        if (subtitleEl && meta) subtitleEl.textContent = meta.subtitle;

        document.querySelectorAll(".sidebar-link[data-page], .tab[data-page]").forEach((link) => {
          const isActive = link.dataset.page === activePage;
          link.classList.toggle("active", isActive);
          if (isActive) {
            link.setAttribute("aria-current", "page");
          } else {
            link.removeAttribute("aria-current");
          }
        });

        document.querySelectorAll(".panel[data-pages]").forEach((panel) => {
          const pages = (panel.dataset.pages || "").split(/\s+/).filter(Boolean);
          const isVisible = pages.includes(activePage);
          panel.classList.toggle("is-page-hidden", !isVisible);
        });
      })();
    </script>
    <script src="/static/app.v2.js"></script>
  </body>
</html>
